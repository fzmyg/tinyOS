# 磁盘驱动

## 数据结构定义

```c
/*ATA通道结构 主盘和从盘公用一个通道 
 *主盘和从盘共享同一通道的端口基址（port base），但使用不同的寄存器（device寄存器中DEV位）或命令来区分操作是针对主盘还是从盘。
 */
struct ide_channel{
    char name[8];                   //通道名称
    uint16_t disk_port_base;        //硬盘操作起始端口号
    uint8_t int_num;                //通道所用中断号
    struct lock channel_lock;       //通道锁
    bool expecting_int;             //标记正在等待硬盘中断
    struct semaphore disk_working;  //用于阻塞，中断程序唤醒继续读或写
    struct disk disks[2];           //通道上连接俩设备一个主盘一个从盘
};

/*硬盘结构 */
struct disk{
    char name[8];                   //硬盘名称
    struct ide_channel* my_channel; //硬盘所属通道
    uint8_t dev_tag;                 //硬盘是主盘0还是从盘1
    struct partition prim_parts[4]; //4个主分区
    struct partition logic_parts[8];//无限多个逻辑分区
};

/*分区结构*/
struct partition{
    char name[8];                   //分区名称
    struct disk*my_disk;            //分区所属的硬盘
    uint32_t start_lba;             //分区起始扇区
    uint32_t sector_cnt;            //扇区数           单个分区最大支持存储 2^32 * 2^9 = 2^41 = 2TB
    struct list_elem part_node;     //用于队列中的标记
    
    struct super_block*sb;          //本分区的超级块
    struct Bitmap block_bitmap;     //块位图 --- 用来表示哪些扇区被使用那些未使用
    struct Bitmap inode_bitmap;     //i节点位图
    struct list open_inodes;        //该分区打开的i节点队列
};
```

## 调用磁盘API

```c
/*读取磁盘内容到buf*/
extern void readDisk(void*const buf,struct disk*hd,uint32_t lba_addr,uint32_t cnt);

/*写入buf内容到磁盘*/
extern void writeDisk(const void*const buf,struct disk*hd,uint32_t lba_addr,uint32_t cnt);

/*初始化磁盘*/
extern void initIDE(void);
```



# 文件系统

## 硬盘结构

- 操作系统引导块：固定在分区中第0个扇区
- 超级块：固定在第1个扇区，描述了空闲块位图，inode位图，inode数组，数据段起始地址等
- 空闲块位图：记录根目录和空闲块区域所占的扇区
- inode位图：记录该分区inode编号的使用情况
- inode数组：记录该分区全部inode信息
- 根目录：存放根目录inode所指数据项的内容
- 空闲区域：可写入扇区



![](C:\Users\24823\Pictures\计算机图片\文件系统\硬盘结构.jpg)

## inode逻辑结构



![](C:\Users\24823\Pictures\计算机图片\文件系统\inode逻辑结构.jpg)



inode数据结构实现

```c
/* 将来会被写入硬盘中 inode表 ， inode表项*/
struct inode{
    uint32_t i_index;               //在inode表中的索引
    uint32_t i_size;                //inode是文件时，i_size为文件大小 ， inode是指该目录下所有目录项大小之和

    uint32_t i_open_cnts;           //文件被打开次数
    uint32_t i_sectors[13];         //12个扇区数据，1个扇区为1级间接块指针

    bool write_denyl;               //防止进程同时写入
    struct list_elem inode_node;    //内存中需链接起相应inode
};
```



inode类型为目录时数据中的数据项为dir_entry

```c
/* 目录的inode指向的数据段的目录条目 */
struct dir_entry{
    char name[MAX_FILE_NAME_LEN]; 	//文件名
    uint32_t i_index;  				//文件的inode索引
    enum file_types  f_type;		//文件类型
};
```



## super_block结构

```C
struct super_block{
    uint32_t magic_number;              //魔数：区分不同的文件系统
    uint32_t sector_cnt;                //分区所占扇区数
    uint32_t inode_cnt;                 //分区inode数
    uint32_t partition_lba_base;        //分区起始地址
    uint32_t block_bitmap_lba;          //块位图起始lba地址
    uint32_t block_bitmap_sector_cnt;   //块位图所占扇区数
    uint32_t inode_bitmap_lba;          //inode位图起始lba地址
    uint32_t inode_bitmap_sector_cnt;   //inode位图所占扇区数
    uint32_t inode_table_lba;           //inode表起始lba地址
    uint32_t inode_table_sector_cnt;    //inode表所占扇区数
    uint32_t data_start_lba;            //数据段起始lba地址
    uint32_t root_inode_index;          //root节点在inode表中的索引
    uint32_t dir_entry_size;            //目录表大小
};
```

